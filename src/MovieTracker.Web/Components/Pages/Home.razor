@page "/"
@using MovieTracker.Domain.Entities
@using MovieTracker.Domain.Interfaces
@using System.Text.Json
@inject ITmdbService TmdbService
@inject IMovieService MovieService
@inject IRecommendationAgent RecommendationAgent
@rendermode InteractiveServer

<PageTitle>Home - Movie Tracker</PageTitle>

<div class="container-fluid">
    <div class="mb-4">
        <h2 class="mb-0"><i class="bi bi-house-door-fill me-2"></i>Home</h2>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Error:</strong> @errorMessage
            <button type="button" class="btn-close" @onclick="ClearError"></button>
        </div>
    }

    @if (isLoading)
    {
        <div class="alert alert-info d-flex align-items-center">
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            <span>Loading...</span>
        </div>
    }

    <!-- Search Section -->
    <div class="mb-4">
        <h4 class="mb-3"><i class="bi bi-search me-2"></i>Search Movies</h4>
        <div class="input-group" style="max-width: 600px;">
            <input type="text" class="form-control" placeholder="Search for movies..."
                   @bind="searchQuery" @bind:event="oninput" @onkeyup="HandleKeyPress" />
            <button class="btn btn-primary" @onclick="SearchMovies" disabled="@isLoading">
                <i class="bi bi-search me-1"></i>Search
            </button>
        </div>
    </div>

    <!-- Search Results -->
    @if (searchResults.Any())
    {
        <div class="mb-5">
            <h4 class="mb-3">Search Results (@searchResults.Count)</h4>
            <div class="list-group">
                @foreach (var movie in searchResults)
                {
                    <div class="list-group-item list-group-item-action clickable d-flex gap-3 py-3"
                         @onclick="() => ShowMovieDetails(movie)">
                        <img src="@(movie.PosterPath ?? "/images/no-poster.png")"
                             alt="@movie.Title"
                             class="movie-poster-sm rounded flex-shrink-0" />
                        <div class="flex-fill">
                            <h6 class="mb-1">@movie.Title</h6>
                            <p class="mb-2 text-muted small">
                                @movie.ReleaseDate?.Year
                                @if (movie.Rating.HasValue)
                                {
                                    <span class="badge bg-warning text-dark ms-2">⭐ @movie.Rating.Value.ToString("0.0")</span>
                                }
                            </p>
                            @if (!string.IsNullOrEmpty(movie.Overview))
                            {
                                <p class="mb-0 small text-muted">
                                    @(movie.Overview.Length > 120 ? movie.Overview.Substring(0, 120) + "..." : movie.Overview)
                                </p>
                            }
                        </div>
                        <div class="d-flex flex-column gap-2 flex-shrink-0">
                            <button class="btn btn-sm btn-success"
                                    @onclick:stopPropagation="true"
                                    @onclick="() => AddToWatchlist(movie)"
                                    disabled="@isLoading">
                                <i class="bi bi-bookmark-plus me-1"></i>Watchlist
                            </button>
                            <button class="btn btn-sm btn-info"
                                    @onclick:stopPropagation="true"
                                    @onclick="() => AddToWatched(movie)"
                                    disabled="@isLoading">
                                <i class="bi bi-check-circle me-1"></i>Watched
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- AI Recommendations -->
    @if (recommendations.Any())
    {
        <div class="mb-5">
            <h4 class="mb-2"><i class="bi bi-robot me-2"></i>AI Recommendations</h4>
            <p class="text-muted mb-3 small">Recommendations based on your watched movies</p>
            <div class="row row-cols-1 g-2" style="max-width: 900px;">
                @foreach (var movie in recommendations)
                {
                    <div class="col">
                        <div class="card card-hover clickable" @onclick="() => ShowMovieDetails(movie)">
                            <div class="row g-0">
                                <div class="col-2">
                                    @if (!string.IsNullOrEmpty(movie.PosterPath))
                                    {
                                        <img src="@movie.PosterPath"
                                             class="img-fluid rounded-start h-100"
                                             style="object-fit: cover; max-height: 100px; margin: 10px;"
                                             alt="@movie.Title" />
                                    }
                                    else
                                    {
                                        <div class="d-flex align-items-center justify-content-center bg-secondary text-white rounded-start h-100" style="min-height: 80px;">
                                            <i class="bi bi-film" style="font-size: 1.5rem;"></i>
                                        </div>
                                    }
                                </div>
                                <div class="col-10">
                                    <div class="card-body p-2 d-flex flex-row align-items-center gap-2">
                                        <div class="flex-fill">
                                            <h5 class="card-title mb-1">@movie.Title (@movie.ReleaseDate?.Year)</h5>
                                            <h6 class="card-text mb-1 small text-muted">Directed by: @movie.Director</h6>
                                            <h6 class="card-text mb-1 small text-muted fst-italic">@movie.Genres</h6>

                                            @if (movie.Rating.HasValue)
                                            {
                                                <span class="badge bg-warning text-dark">⭐ @movie.Rating.Value.ToString("0.0")</span>
                                            }

                                        </div>
                                        <div class="d-flex gap-1 flex-shrink-0">
                                            <button class="btn btn-sm btn-outline-success"
                                                    @onclick:stopPropagation="true"
                                                    @onclick="() => AddToWatchlist(movie)">
                                                <i class="bi bi-bookmark-plus me-1"></i>Add to Watchlist
                                            </button>
                                            <button class="btn btn-sm btn-outline-info"
                                                    @onclick:stopPropagation="true"
                                                    @onclick="() => AddToWatched(movie)">
                                                <i class="bi bi-check-circle me-1"></i>Mark as Watched
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    else if (watched.Any())
    {
        <div class="card text-center p-4">
            <div class="card-body">
                <i class="bi bi-robot display-4 text-muted mb-3"></i>
                <h4>Want movie recommendations?</h4>
                <p class="text-muted">Get personalized AI-powered recommendations based on your watched movies</p>
                <button class="btn btn-primary" @onclick="LoadRecommendations" disabled="@isLoading">
                    <i class="bi bi-robot me-2"></i>Get AI Recommendations
                </button>
            </div>
        </div>
    }
</div>

@if (selectedMovie != null)
{
    <MovieDetailsModal Movie="selectedMovie" OnClose="CloseMovieDetails"
                       OnAddToWatchlist="AddToWatchlist" OnAddToWatched="AddToWatched" />
}

@code {
    private string searchQuery = "";
    private List<Movie> searchResults = new();
    private List<Movie> recommendations = new();
    private List<WatchedMovie> watched = new();
    private Movie? selectedMovie;
    private bool isLoading = false;
    private string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await SafeExecute(async () =>
        {
            watched = await MovieService.GetWatchedMoviesAsync();
        });
    }

    private async Task SafeExecute(Func<Task> action)
    {
        try
        {
            isLoading = true;
            errorMessage = "";
            await action();
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Network error: {ex.Message}. Please check your internet connection.";
            Console.WriteLine($"HTTP Error: {ex}");
        }
        catch (JsonException ex)
        {
            errorMessage = $"Data error: {ex.Message}. The API returned invalid data.";
            Console.WriteLine($"JSON Error: {ex}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}. Please try again.";
            Console.WriteLine($"Error: {ex}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ClearError()
    {
        errorMessage = "";
    }

    private async Task LoadRecommendations()
    {
        await SafeExecute(async () =>
        {
            var watchedTitles = watched.Select(m => m.Title).ToList();
            recommendations = await RecommendationAgent.GetPersonalizedRecommendationsAsync(watchedTitles, 3);
        });
    }

    private async Task SearchMovies()
    {
        await SafeExecute(async () =>
        {
            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                var results = await TmdbService.SearchMoviesAsync(searchQuery);
                searchResults = results.Take(10).ToList();
            }
        });
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchMovies();
        }
    }

    private async Task AddToWatchlist(Movie movie)
    {
        await SafeExecute(async () =>
        {
            // Fetch full details to get actors
            var fullMovie = await TmdbService.GetMovieDetailsAsync(movie.TmdbId);

            var watchlistMovie = new WatchlistMovie
            {
                TmdbId = fullMovie?.TmdbId ?? movie.TmdbId,
                Title = fullMovie?.Title ?? movie.Title,
                PosterPath = fullMovie?.PosterPath ?? movie.PosterPath,
                Overview = fullMovie?.Overview ?? movie.Overview,
                ReleaseDate = fullMovie?.ReleaseDate ?? movie.ReleaseDate,
                Director = fullMovie?.Director ?? movie.Director,
                Genres = fullMovie?.Genres ?? movie.Genres,
                Rating = fullMovie?.Rating ?? movie.Rating,
                Runtime = fullMovie?.Runtime ?? movie.Runtime,
                Actors = fullMovie?.Actors ?? movie.Actors
            };

            await MovieService.AddToWatchlistAsync(watchlistMovie);
            selectedMovie = null;
        });
    }

    private async Task AddToWatched(Movie movie)
    {
        await SafeExecute(async () =>
        {
            // Fetch full details to get actors
            var fullMovie = await TmdbService.GetMovieDetailsAsync(movie.TmdbId);

            var watchedMovie = new WatchedMovie
            {
                TmdbId = fullMovie?.TmdbId ?? movie.TmdbId,
                Title = fullMovie?.Title ?? movie.Title,
                PosterPath = fullMovie?.PosterPath ?? movie.PosterPath,
                Overview = fullMovie?.Overview ?? movie.Overview,
                ReleaseDate = fullMovie?.ReleaseDate ?? movie.ReleaseDate,
                Director = fullMovie?.Director ?? movie.Director,
                Genres = fullMovie?.Genres ?? movie.Genres,
                Rating = fullMovie?.Rating ?? movie.Rating,
                Runtime = fullMovie?.Runtime ?? movie.Runtime,
                Actors = fullMovie?.Actors ?? movie.Actors
            };

            await MovieService.AddToWatchedAsync(watchedMovie);
            watched = await MovieService.GetWatchedMoviesAsync();
            selectedMovie = null;
        });
    }

    private async Task ShowMovieDetails(Movie movie)
    {
        await SafeExecute(async () =>
        {
            selectedMovie = await TmdbService.GetMovieDetailsAsync(movie.TmdbId);
        });
    }

    private void CloseMovieDetails()
    {
        selectedMovie = null;
    }
}

