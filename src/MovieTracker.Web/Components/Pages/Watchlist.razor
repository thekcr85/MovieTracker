@page "/watchlist"
@using MovieTracker.Domain.Entities
@using MovieTracker.Domain.Interfaces
@inject IMovieService MovieService
@rendermode InteractiveServer

<PageTitle>Watchlist - Movie Tracker</PageTitle>

<div class="mb-4">
    <h2 class="mb-0">
        <i class="bi bi-bookmark me-2"></i>Watchlist
    </h2>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>Error:</strong> @errorMessage
        <button type="button" class="btn-close" @onclick="ClearError"></button>
    </div>
}

@if (isLoading)
{
    <div class="alert alert-info d-flex align-items-center">
        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
        <span>Loading...</span>
    </div>
}

<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">Movies to Watch (@watchlist.Count)</h5>
    </div>

    <div class="card-body p-0">
        @if (watchlist.Any())
        {
            <div class="list-group list-group-flush scrollable-list">
                @foreach (var movie in watchlist)
                {
                    <div class="list-group-item list-group-item-action clickable d-flex gap-3 py-3"
                         @onclick="() => ShowMovieDetails(movie)">
                        <img src="@(movie.PosterPath ?? "/images/no-poster.png")" 
                             alt="@movie.Title poster"
                             class="movie-poster-sm rounded flex-shrink-0" />

                        <div class="flex-fill">
                            <h6 class="mb-1">@movie.Title</h6>
                            <p class="mb-1 small text-muted">
                                @movie.ReleaseDate?.Year
                                @if (movie.Rating.HasValue)
                                {
                                    <span class="badge bg-warning text-dark ms-2">‚≠ê @movie.Rating.Value.ToString("0.0")</span>
                                }
                            </p>
                            <p class="mb-1 small text-muted">
                                <i class="bi bi-calendar-plus me-1"></i>Added: @movie.AddedDate.ToString("MMM dd, yyyy")
                            </p>
                            @if (!string.IsNullOrEmpty(movie.Genres))
                            {
                                <p class="mb-0 small text-muted">
                                    <i class="bi bi-tag me-1"></i>@movie.Genres
                                </p>
                            }
                        </div>

                        <div class="d-flex flex-column gap-2 flex-shrink-0">
                            <button class="btn btn-sm btn-success" 
                                    @onclick:stopPropagation="true"
                                    @onclick="() => MoveToWatched(movie.Id)"
                                    disabled="@isLoading">
                                <i class="bi bi-check-circle me-1"></i>Watched
                            </button>
                            <button class="btn btn-sm btn-danger"
                                    @onclick:stopPropagation="true"
                                    @onclick="() => RemoveFromWatchlist(movie.Id)"
                                    disabled="@isLoading">
                                <i class="bi bi-trash me-1"></i>Remove
                            </button>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="text-center py-5 px-3">
                <i class="bi bi-bookmark display-1 text-muted mb-3"></i>
                <h4 class="mb-2">Your watchlist is empty</h4>
                <p class="text-muted mb-3">Search for movies and add them to your watchlist!</p>
                <a href="/" class="btn btn-primary">
                    <i class="bi bi-search me-2"></i>Search Movies
                </a>
            </div>
        }
    </div>
</div>

<!-- Movie Details Modal -->
@if (selectedMovie != null)
{
    <WatchlistMovieModal Movie="selectedMovie" 
                        OnClose="CloseMovieDetails" 
                        OnMoveToWatched="MoveToWatched"
                        OnRemove="RemoveFromWatchlist" />
}

@code {
    private List<WatchlistMovie> watchlist = new();
    private WatchlistMovie? selectedMovie;
    private bool isLoading;
    private string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadWatchlist();
    }

    private async Task SafeExecute(Func<Task> action)
    {
        try
        {
            isLoading = true;
            errorMessage = "";
            await action();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            Console.WriteLine($"Error: {ex}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ClearError() => errorMessage = "";

    private async Task LoadWatchlist()
    {
        await SafeExecute(async () =>
        {
            watchlist = await MovieService.GetWatchlistMoviesAsync();
        });
    }

    private void ShowMovieDetails(WatchlistMovie movie) => selectedMovie = movie;

    private void CloseMovieDetails() => selectedMovie = null;

    private async Task MoveToWatched(int watchlistMovieId)
    {
        await SafeExecute(async () =>
        {
            await MovieService.MoveToWatchedAsync(watchlistMovieId);
            await LoadWatchlist();
            selectedMovie = null;
        });
    }

    private async Task RemoveFromWatchlist(int id)
    {
        await SafeExecute(async () =>
        {
            await MovieService.RemoveFromWatchlistAsync(id);
            await LoadWatchlist();
            selectedMovie = null;
        });
    }
}
